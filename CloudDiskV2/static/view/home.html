<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>Clouddisk é¦–é¡µ</title>
  <script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>

  <script src="/static/js/auth.js"></script>

  <style>
    body {
      background-color: #f4f6f9;
      font-family: "Microsoft YaHei", sans-serif;
    }

    .navbar-custom {
      background: linear-gradient(90deg, #6fb1fc, #4364f7);
      color: #fff;
      font-weight: bold;
      font-size: 18px;
      padding: 10px 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar-title {
      font-size: 20px;
    }

    .user-info {
      display: flex;
      align-items: center;
    }

    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      border: 2px solid #fff;
    }

    .user-text {
      color: #fff;
      font-size: 14px;
      line-height: 1.2;
      text-align: left;
    }

    .content {
      background: #fff;
      padding: 25px;
      margin: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .content h4 {
      margin: 0;
      font-weight: bold;
      color: #333;
    }

    .divider {
      height: 2px;
      background: #6fb1fc;
      margin: 15px 0;
    }

    .file-table th {
      background: #f1f4f9;
      text-align: center;
    }

    .file-table td {
      text-align: center;
      vertical-align: middle !important;
    }

    .btn-upload {
      background: #28a745;
      color: #fff;
      border-radius: 20px;
      padding: 6px 20px;
      transition: 0.2s;
    }

    .btn-upload:hover {
      background: #218838;
      color: #fff;
    }
  </style>
</head>

<body>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <div class="navbar-custom">
    <div class="navbar-title">Clouddisk äº‘ç›˜é¦–é¡µ</div>
    <div class="user-info">
      <img src="/static/img/avatar.jpeg" alt="ç”¨æˆ·å¤´åƒ">
      <div class="user-text">
        <div id="username">åŠ è½½ä¸­...</div>
        <div id="regtime"></div>
      </div>
    </div>
  </div>

  <!-- å†…å®¹åŒº -->
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="content">
          <div class="clearfix">
            <h4 class="pull-left">ğŸ“‚ æ–‡ä»¶åˆ—è¡¨</h4>
            <button class="btn btn-upload pull-right" onclick="toUploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
          </div>
          <div class="divider"></div>
          <table id="filetbl" class="table table-bordered table-hover file-table">
            <thead>
              <tr>
                <th>æ–‡ä»¶å“ˆå¸Œ</th>
                <th>æ–‡ä»¶å</th>
                <th>å¤§å°</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>æœ€åä¿®æ”¹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS åŠ¨æ€å¡«å…… -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.onload = function () {
      $.ajax({
        url: "/user/info?" + queryParams(),
        type: "GET",
        dataType: "text",
        success: function (body) {
          var resp = JSON.parse(body);
          document.getElementById("username").innerText = resp.data.Username;
          document.getElementById("regtime").innerText = resp.data.SignupAt;
          updateFileList();
        },
        error: function (jqXHR, textStatus, errorThrown) {
          alert(textStatus + " : " + errorThrown);
        }
      });
    }

    function queryParams() {
      let username = localStorage.getItem("username");
      let token = localStorage.getItem("token");
      if (!username || !token) {
        return "";
      }
      return "username=" + encodeURIComponent(username) + "&token=" + encodeURIComponent(token);
    }

    function updateFileList() {
      $.ajax({
        url: "/file/query?" + queryParams(),
        type: "POST",
        data: { limit: 15 },
        success: function (body) {
          if (!body) return;
          var data = JSON.parse(body);
          if (!data || data.length <= 0) return;

          var tableBody = document.getElementById('filetbl').getElementsByTagName('tbody')[0];
          tableBody.innerHTML = "";

          for (var i = 0; i < data.length; i++) {
            var row = tableBody.insertRow();
            row.insertCell().innerHTML = data[i].FileHash.substr(0, 20) + "...";
            row.insertCell().innerHTML = data[i].FileName;
            row.insertCell().innerHTML = data[i].FileSize + " bytes";
            row.insertCell().innerHTML = data[i].UploadAt;
            row.insertCell().innerHTML = data[i].LastUpdated;
            row.insertCell().innerHTML =
              '<button class="btn btn-primary btn-xs" onclick="downloadFile(\'/file/download?filename=' +
              data[i].FileName + '&filehash=' + data[i].FileHash + '&' + queryParams() + '\')">ä¸‹è½½</button> ' +
              '<button class="btn btn-danger btn-xs" onclick="deleteFile(\'' +
              data[i].FileHash + '\', \'' + data[i].FileName + '\')">åˆ é™¤</button>';
          }
        }
      });
    }

    function toUploadFile() {
      window.location.href = '/file/upload?' + queryParams();
    }

    function downloadFile(durl) {
      window.location.href = durl;
    }

    // åˆ é™¤æ–‡ä»¶æ¥å£è°ƒç”¨
    function deleteFile(filehash, filename) {
      if (!confirm("ç¡®è®¤åˆ é™¤æ–‡ä»¶ã€" + filename + "ã€‘å—ï¼Ÿ")) {
        return;
      }
      $.ajax({
        url: "/file/delete?" + queryParams(),
        type: "POST",
        dataType: "json",   // ğŸ‘ˆ è‡ªåŠ¨è§£æ
        data: { filehash: filehash, filename: filename },
        success: function (res) {
          if (res.status === "SUCCESS") {
            alert("æ–‡ä»¶åˆ é™¤æˆåŠŸï¼" + (res.msg || ""));
            updateFileList();
          } else {
            alert("æ–‡ä»¶åˆ é™¤å¤±è´¥ï¼" + (res.msg || ""));
          }
        },
        error: function () {
          alert("è¯·æ±‚åˆ é™¤å¤±è´¥ï¼");
        }
      });
    }

  </script>
</body>

</html>